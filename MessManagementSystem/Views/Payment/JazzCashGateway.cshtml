@model MessManagementSystem.Models.Bill

@{
    Layout = null;
}

<!DOCTYPE html>
<html>
<head>
    <title>Secure Payment</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Changed styling from JazzCash Red to Stripe Blue/Standard */
        .payment-header {
            background-color: #32325d;
            color: #fff;
            padding: 15px;
            border-bottom: 5px solid #6772e5;
        }

        .payment-card {
            border: 1px solid #e6ebf1;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(50, 50, 93, 0.11), 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .StripeElement {
            box-sizing: border-box;
            height: 40px;
            padding: 10px 12px;
            border: 1px solid transparent;
            border-radius: 4px;
            background-color: white;
            box-shadow: 0 1px 3px 0 #e6ebf1;
            -webkit-transition: box-shadow 150ms ease;
            transition: box-shadow 150ms ease;
        }

        .StripeElement--focus {
            box-shadow: 0 1px 3px 0 #cfd7df;
        }

        .StripeElement--invalid {
            border-color: #fa755a;
        }

        .StripeElement--webkit-autofill {
            background-color: #fefde5 !important;
        }
    </style>
</head>
<body class="bg-light">

    <div class="payment-header text-center">
        <h4>🔒 Secure Payment Gateway</h4>
    </div>

    <div class="container mt-5" style="max-width: 500px;">
        <div class="payment-card bg-white">
            <div class="payment-card bg-white">

                @if (ViewBag.Error != null)
                {
                    <div class="alert alert-danger text-center m-3">
                        <strong>Payment Failed:</strong> @ViewBag.Error
                    </div>
                }
                <div class="p-4 text-center border-bottom bg-light">
                    <h5 class="text-muted">Mess Bill Payment</h5>
                    
            <div class="p-4 text-center border-bottom bg-light">
                <h5 class="text-muted">Mess Bill Payment</h5>
                <h1 class="text-primary fw-bold my-3">Rs. @Model.TotalAmount</h1>
                <p class="mb-0">For @Model.BillMonth / @Model.BillYear</p>
            </div>

            <div class="p-4">
                <form action="/Payment/ProcessPayment" method="POST" id="payment-form">
                    <input type="hidden" name="billId" value="@Model.BillId" />

                    <div class="mb-4">
                        <label class="fw-bold mb-2">Credit or Debit Card</label>
                        <div id="card-element" class="form-control p-3"></div>
                        <div id="card-errors" class="text-danger mt-2 small"></div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg w-100 shadow-sm">
                        Pay Rs. @Model.TotalAmount
                    </button>

                    <div class="text-center mt-3">
                        <a href="/Teacher/MyBills" class="text-decoration-none text-muted">Cancel Payment</a>
                    </div>
                </form>
            </div>
        </div>
        <div class="text-center mt-3 text-muted">
            <small>Powered by <span class="fw-bold">Stripe</span>. Payments are secure and encrypted.</small>
        </div>
    </div>

    <script src="https://js.stripe.com/v3/"></script>
    <script>
        // -------------------------------------------------------------------
        // IMPORTANT: PASTE YOUR REAL STRIPE KEY BELOW
        // It should look like: 'pk_test_51Pq...'
        // -------------------------------------------------------------------
        var stripe = Stripe('');

        var elements = stripe.elements();

        // Custom styling can be passed to options when creating an Element.
        var style = {
            base: {
                color: '#32325d',
                fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
                fontSmoothing: 'antialiased',
                fontSize: '16px',
                '::placeholder': {
                    color: '#aab7c4'
                }
            },
            invalid: {
                color: '#fa755a',
                iconColor: '#fa755a'
            }
        };

        // Create an instance of the card Element.
        var card = elements.create('card', { style: style });

        // Add an instance of the card Element into the `card-element` <div>.
        card.mount('#card-element');

        // Handle Form Submission
        var form = document.getElementById('payment-form');
        form.addEventListener('submit', function(event) {
            event.preventDefault();

            stripe.createToken(card).then(function(result) {
                if (result.error) {
                    // Show error to your customer
                    var errorElement = document.getElementById('card-errors');
                    errorElement.textContent = result.error.message;
                } else {
                    // Send the token to your server
                    stripeTokenHandler(result.token);
                }
            });
        });

        function stripeTokenHandler(token) {
            // Insert the token ID into the form so it gets submitted to the server
            var form = document.getElementById('payment-form');
            var hiddenInput = document.createElement('input');
            hiddenInput.setAttribute('type', 'hidden');
            hiddenInput.setAttribute('name', 'stripeToken');
            hiddenInput.setAttribute('value', token.id);
            form.appendChild(hiddenInput);

            // Submit the form
            form.submit();
        }
    </script>

</body>
</html>